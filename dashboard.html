<!DOCTYPE html>
<html>
<head>
    <title>My Taiwan Meal Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .info-content {
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        .info-content img {
            max-width: 250px;
            height: auto;
            display: block;
            margin-top: 5px;
            border-radius: 4px;
        }
        .info-content h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        .info-content p {
            margin: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Load PapaParse CSV parser from CDN
        function loadPapaParse() {
            return new Promise((resolve) => {
                const script = document.createElement('script');
                script.src = "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js";
                script.onload = () => resolve();
                document.head.appendChild(script);
            });
        }

        const Maps_API_KEY = 'AIzaSyDeimKlA6jGIwlPg2W9sVt_Kqnaa9kPsjk';  // Your new restricted API key
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTOkDWVy83RTZw0S2Ihd3lM9Y82P0bCx7EgfeLuYoPCGEFOMwjdMlhFB2uVegLoIqKSuQwO59oNSg-L/pub?gid=683707284&single=true&output=csv';

        let map;

        function convertDriveUrlForImage(url) {
            if (!url) return '';
            // Try to parse Google Drive URLs in different formats
            let match = url.match(/\/d\/([a-zA-Z0-9_-]+)\/view/);
            if (!match) {
                match = url.match(/open\?id=([a-zA-Z0-9_-]+)/);
            }
            if (match && match[1]) {
                return `https://drive.google.com/uc?id=${match[1]}&export=download`;
            }
            return url;
        }

        async function fetchCsvData(url) {
            const response = await fetch(url);
            const text = await response.text();
            return new Promise((resolve, reject) => {
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        resolve(results.data);
                    },
                    error: function(err) {
                        reject(err);
                    }
                });
            });
        }

        async function initMap() {
            // Load PapaParse first
            await loadPapaParse();

            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const { InfoWindow } = await google.maps.importLibrary("maps");

            map = new Map(document.getElementById("map"), {
                center: { lat: 25.0330, lng: 121.5654 },
                zoom: 12,
            });

            const meals = await fetchCsvData(GOOGLE_SHEET_CSV_URL);
            const infoWindow = new InfoWindow();

            meals.forEach(meal => {
                const restaurantName = meal['Restaurant Name'];
                const mealName = meal['Meal Name/ Dish'];
                const photoUrl = meal['Upload a photo of the meal.'];
                const latitude = parseFloat(meal['Location- Latitude']);
                const longitude = parseFloat(meal['Location- Longitude']);
                const rating = meal['Overall Rating'];
                const review = meal['Notes'];
                const dateTimeVisited = meal['Date of Meal'];

                if (isNaN(latitude) || isNaN(longitude)) {
                    console.warn(`Skipping invalid location: ${restaurantName} - ${mealName}`);
                    return;
                }

                const position = { lat: latitude, lng: longitude };
                const marker = new AdvancedMarkerElement({
                    map: map,
                    position: position,
                    title: `${restaurantName} - ${mealName}`
                });

                const embeddablePhotoUrl = convertDriveUrlForImage(photoUrl);
                const infoWindowContent = `
                    <div class="info-content">
                        <h3>${restaurantName} - ${mealName}</h3>
                        <p>Date: ${dateTimeVisited || 'N/A'}</p>
                        <p>Rating: ${rating || 'N/A'}/5</p>
                        <p>Notes: ${review || 'N/A'}</p>
                        ${embeddablePhotoUrl ? `<img src="${embeddablePhotoUrl}" alt="${mealName} photo">` : ''}
                    </div>
                `;

                marker.addListener('click', () => {
                    infoWindow.setContent(infoWindowContent);
                    infoWindow.open(map, marker);
                });
            });
        }

        // Load Google Maps script and initialize map
        function loadGoogleMaps() {
            return new Promise((resolve) => {
                window.initMap = () => resolve();
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${Maps_API_KEY}&callback=initMap&libraries=marker`;
                script.async = true;
                document.head.appendChild(script);
            });
        }

        // Start everything
        loadGoogleMaps();
    </script>
</body>
</html>
