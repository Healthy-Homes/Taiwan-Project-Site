<!DOCTYPE html>
<html>
<head>
    <title>My Taiwan Meal Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .info-content {
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        .info-content img {
            max-width: 250px;
            height: auto;
            display: block;
            margin-top: 5px;
            border-radius: 4px;
        }
        .info-content h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        .info-content p {
            margin: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const Maps_API_KEY = 'AIzaSyD-yKsbe9UEXo-ftRM-cA1XbeGknQ9azyk';
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTOkDWVy83RTZw0S2Ihd3lM9Y82P0bCx7EgfeLuYoPCGEFOMwjdMlhFB2uVegLoIqKSuQwO59oNSg-L/pub?gid=683707284&single=true&output=csv';

        let map;

        function convertDriveUrlForImage(url) {
            if (!url) return '';
            const match = url.match(/\/d\/([a-zA-Z0-9_-]+)\/view/);
            if (match && match[1]) {
                return `https://drive.google.com/uc?id=${match[1]}&export=download`;
            }
            return url;
        }

        async function fetchCsvData(url) {
            const response = await fetch(url);
            const text = await response.text();
            const rows = text.trim().split('\n');
            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < rows.length; i++) {
                const values = rows[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length === headers.length) {
                    let row = {};
                    headers.forEach((h, j) => row[h] = values[j]);
                    data.push(row);
                }
            }
            return data;
        }

        async function initMap() {
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const { InfoWindow } = await google.maps.importLibrary("maps");

            map = new Map(document.getElementById("map"), {
                center: { lat: 25.0330, lng: 121.5654 },
                zoom: 12,
            });

            const meals = await fetchCsvData(GOOGLE_SHEET_CSV_URL);
            const infoWindow = new InfoWindow();

            meals.forEach(meal => {
                const restaurantName = meal['Restaurant Name'];
                const mealName = meal['Meal Name/ Dish'];
                const photoUrl = meal['Upload a photo of the meal.'];
                const latitude = parseFloat(meal['Location- Latitude']);
                const longitude = parseFloat(meal['Location- Longitude']);
                const rating = meal['Overall Rating'];
                const review = meal['Notes'];
                const dateTimeVisited = meal['Date of Meal'];

                if (isNaN(latitude) || isNaN(longitude)) {
                    console.warn(`Skipping invalid location: ${restaurantName} - ${mealName}`);
                    return;
                }

                const position = { lat: latitude, lng: longitude };
                const marker = new AdvancedMarkerElement({
                    map: map,
                    position: position,
                    title: `${restaurantName} - ${mealName}`
                });

                const embeddablePhotoUrl = convertDriveUrlForImage(photoUrl);
                const infoWindowContent = `
                    <div class="info-content">
                        <h3>${restaurantName} - ${mealName}</h3>
                        <p>Date: ${dateTimeVisited || 'N/A'}</p>
                        <p>Rating: ${rating || 'N/A'}/5 stars</p>
                        ${embeddablePhotoUrl ? `<img src="${embeddablePhotoUrl}" alt="${mealName} photo">` : ''}
                        <p>${review || ''}</p>
                    </div>
                `;

                marker.addListener('click', () => {
                    infoWindow.setContent(infoWindowContent);
                    infoWindow.open(map, marker);
                });
            });
        }

        function loadGoogleMapsScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${Maps_API_KEY}&callback=initMap&v=beta&libraries=marker`;
            script.async = true;
            document.head.appendChild(script);
        }

        loadGoogleMapsScript();
    </script>
</body>
</html>
