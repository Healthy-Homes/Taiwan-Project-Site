<!DOCTYPE html>
<html>
<head>
    <title>My Taiwan Meal Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .info-content {
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        .info-content img {
            max-width: 250px;
            height: auto;
            display: block;
            margin-top: 5px;
            border-radius: 4px;
        }
        .info-content h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        .info-content p {
            margin: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const Maps_API_KEY = 'AIzaSyD-yKsbe9UEXo-ftRM-cA1XbeGknQ9azyk';
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/1yo4USRjkel7Oz7oqb0wf03K7ii-VojzZfOWmM2q7Yv4/pub?output=csv';

        let map;

        function convertDriveUrlForImage(url) {
            if (!url) return '';
            const match = url.match(/\/d\/([a-zA-Z0-9_-]+)\/view/);
            if (match && match[1]) {
                return `https://drive.google.com/uc?id=${match[1]}&export=download`;
            }
            return url;
        }

        async function fetchCsvData(url) {
            const response = await fetch(url);
            const text = await response.text();
            const rows = text.trim().split('\n');
            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < rows.length; i++) {
                const values = rows[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length === headers.length) {
                    let row = {};
                    headers.forEach((h, j) => row[h] = values[j]);
                    data.push(row);
                }
            }
            return data;
        }

        async function initMap() {
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const { InfoWindow } = await google.maps.importLibrary("maps");

            map = new Map(document.getElementById("map"), {
                center: { lat: 25.0330, lng: 121.5654 },
                zoom: 12,
                mapId: "YOUR_MAP_ID",
            });

            const meals = await fetchCsvData(GOOGLE_SHEET_CSV_URL);
            const infoWindow = new InfoWindow();

            meals.forEach(meal => {
                const restaurantName = meal['Restaurant Name'];
                const mealName = meal['Meal Name / Dish'];
                const photoUrl = meal['Photo'];
                const latitude = parseFloat(meal.Latitude);
                const longitude = parseFloat(meal.Longitude);
                const rating = meal['Rating (1-5 stars)'];
                const review = meal.Review;
                const dateTimeVisited = meal['Date & Time Visited'];

                if (isNaN(latitude) || isNaN(longitude)) {
                    console.warn(`Skipping invalid location: ${restaurantName} - ${mealName}`);
                    return;
                }

                const position = { lat: latitude, lng: longitude };
                const marker = new AdvancedMarkerElement({
                    map: map,
                    position: position,
                    title: `${restaurantName} - ${mealName}`
                });

                const embeddablePhotoUrl = convertDriveUrlForImage(photoUrl);
                const infoWindowContent = `
                    <div class="info-content">
                        <h3>${restaurantName} - ${mealName}</h3>
                        <p>Rating: ${rating || 'N/A'}/5 stars</p>
                        ${embeddablePhotoUrl ? `<img src="${embeddablePhotoUrl}" alt="${mealName} photo">` : ''}
                        <p>${review || 'No review provided.'}</p>
                        <p>Visited: ${dateTimeVisited || 'N/A'}</p>
                    </div>
                `;

                marker.addListener("click", () => {
                    infoWindow.close();
                    infoWindow.setContent(infoWindowContent);
                    infoWindow.open(map, marker);
                });
            });
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-yKsbe9UEXo-ftRM-cA1XbeGknQ9azyk&libraries=marker&callback=initMap"></script>
</body>
</html>
